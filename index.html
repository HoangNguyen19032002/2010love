<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Binary Love ‚Äî Gallery</title>
  <style>
    :root{
      --bg:#fff6fb;           /* n·ªÅn tr·∫Øng h·ªìng r·∫•t nh·∫π */
      --ink:#3a2a3f;          /* ch·ªØ t√≠m than */
      --muted:#7b6b86;        /* ch·ªØ ph·ª• */
      --card:#ffffff;         /* th·∫ª tr·∫Øng */
      --border:#f3e3f7;       /* vi·ªÅn h·ªìng nh·∫°t */
      --grad1:#ffe0ef;        /* gradient h·ªìng */
      --grad2:#e8e0ff;        /* gradient t√≠m */
      --grad3:#fff6d6;        /* gradient v√†ng nh·∫°t */
      --accent:#ff5ea7;       /* h·ªìng t∆∞∆°i */
      --accent2:#8b5cf6;      /* t√≠m */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:var(--ink);background:linear-gradient(120deg,var(--grad1),var(--grad2) 50%,var(--grad3));background-attachment:fixed}

    /* Layout */
    .page{min-height:100%;display:flex;flex-direction:column}
    header{padding:16px 18px;display:flex;align-items:center;gap:12px}
    header h1{font-size:20px;margin:0}
    header .sub{color:var(--muted);font-size:13px}

    .wrap{flex:1;display:flex;justify-content:center;padding:10px}
    .frame{width:min(1100px,96vw);display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:980px){.frame{grid-template-columns:1fr 320px}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.8));border:1px solid var(--border);border-radius:18px;box-shadow:0 15px 30px rgba(151,120,180,0.18);overflow:hidden}
    .card-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.5));border-bottom:1px solid var(--border)}
    .card-title{font-weight:700}
    .hint{font-size:12px;color:var(--muted)}

    .canvas-wrap{position:relative}
    canvas#art{display:block;width:100%;height:auto;background:#ffffff}

    .controls{position:absolute;right:10px;bottom:10px;display:flex;gap:8px;z-index:5}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:999px;padding:9px 12px;font-weight:600;background:#fff;color:#5a476e;border:1px solid var(--border);box-shadow:0 6px 20px rgba(148,113,180,0.18)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;border:none}

    /* Filmstrip */
    .strip{display:flex;gap:10px;overflow:auto;padding:10px;background:linear-gradient(180deg,#fff,rgba(255,255,255,0.85));border-top:1px solid var(--border)}
    .thumb{flex:0 0 auto;width:88px;height:120px;border-radius:12px;overflow:hidden;border:1px solid var(--border);background:#fff;position:relative;cursor:pointer}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb.active{outline:3px solid rgba(255,94,167,0.6)}

    /* Sidebar */
    .side{background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.8));border:1px solid var(--border);border-radius:18px;padding:12px 14px}
    .side h3{margin:6px 0 8px;font-size:15px}
    .side p,.side li{color:var(--muted);font-size:13px}
    .side code{background:#fff0fa;padding:2px 6px;border-radius:6px;border:1px solid var(--border)}

    /* Hearts FX */
    canvas#fx{position:fixed;inset:0;pointer-events:none;z-index:2}

    footer{display:flex;justify-content:center;padding:12px 0 18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <canvas id="fx"></canvas>

  <div class="page">
    <header>
      <div style="width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#ffd0e6,#e5d8ff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#6d3d7a">01</div>
      <div>
        <h1>Binary Love ‚Äî Gallery</h1>
        <div class="sub">ƒê·∫∑t ·∫£nh v√†o th∆∞ m·ª•c <code>anh/</code> ‚Üí Trang t·ª± ch·∫°y ki·ªÉu cu·ªôn phim; click/ch·∫°m ƒë·ªÉ tung üíñ.</div>
      </div>
    </header>

    <main class="wrap">
      <div class="frame">
        <section class="card">
          <div class="card-header">
            <div class="card-title">Khung ch√≠nh</div>
            <div class="hint">·∫¢nh trong repo ‚Üí chuy·ªÉn th√†nh 0/1 theo th·ªùi gian th·ª±c.</div>
          </div>
          <div class="canvas-wrap">
            <canvas id="art" width="1400" height="900" aria-label="Binary portrait"></canvas>
            <div class="controls">
              <button class="btn" id="prev">‚óÄÔ∏é</button>
              <button class="btn" id="rerender">V·∫Ω l·∫°i</button>
              <a class="btn primary" id="download" href="#">T·∫£i PNG</a>
              <button class="btn" id="next">‚ñ∂Ô∏é</button>
            </div>
          </div>
          <div id="strip" class="strip" aria-label="Filmstrip thumbnails"></div>
        </section>

        <aside class="side">
          <h3>C√°ch th√™m ·∫£nh (kh√¥ng s·ª≠a code)</h3>
          <ol>
            <li>T·∫°o th∆∞ m·ª•c <code>anh/</code> (c√πng c·∫•p v·ªõi <code>index.html</code>).</li>
            <li>Th√™m ·∫£nh t·ª± do: <code>.jpg .jpeg .png .webp</code>.</li>
            <li>T·∫°o file <code>anh/images.json</code> ch·ª©a danh s√°ch t√™n ·∫£nh, v√≠ d·ª•:
<pre>["01.jpg","02.jpg","ky-niem.png"]</pre>
            </li>
            <li>Commit ‚Üí reload trang. N·∫øu kh√¥ng c√≥ <code>images.json</code>, trang s·∫Ω th·ª≠ c√°c t√™n theo m·∫´u: <code>img-1.jpg .. img-20.jpg</code>.</li>
          </ol>
          <h3>M·∫πo hi·ªÉn th·ªã</h3>
          <ul>
            <li>·∫¢nh t·ªâ l·ªá d·ªçc 3:4 ho·∫∑c vu√¥ng; ƒë·ªô t∆∞∆°ng ph·∫£n t·ªët.</li>
            <li>K√©o filmstrip ƒë·ªÉ ch·ªçn ·∫£nh; t·ª± ƒë·ªông ch·∫°y (c√≥ th·ªÉ t·∫Øt trong c·∫•u h√¨nh).</li>
          </ul>
        </aside>
      </div>
    </main>

    <footer>Theme h·ªìng‚Äìt√≠m‚Äìv√†ng nh·∫°t, hi·ªáu ·ª©ng tim üíñ. Ch·∫°y 100% trong tr√¨nh duy·ªát.</footer>
  </div>

<script>
// ========================
// CONFIG ‚Äî ch·ªânh ·ªü ƒë√¢y n·∫øu mu·ªën
// ========================
const CONFIG = {
  MANIFEST: 'anh/images.json', // n·∫øu t·ªìn t·∫°i, d√πng danh s√°ch trong file n√†y
  FALLBACK_PREFIX: 'anh/img-', // n·∫øu kh√¥ng c√≥ manifest ‚Üí th·ª≠ img-1.jpg..img-20.jpg
  FALLBACK_EXT: '.jpg',
  FALLBACK_COUNT: 20,
  AUTOPLAY: true,
  AUTOPLAY_MS: 3500,
  CELL: 9,
  THRESHOLD: 0.5,
  MODE: 'binary', // 'binary' | 'zeros' | 'ones' | 'random'
  PADDING: 18
};

// Elements
const art = document.getElementById('art');
const ctx = art.getContext('2d');
const fx = document.getElementById('fx');
const fxc = fx.getContext('2d');
const strip = document.getElementById('strip');
const btnPrev = document.getElementById('prev');
const btnNext = document.getElementById('next');
const btnRender = document.getElementById('rerender');
const btnDownload = document.getElementById('download');

let images = [];      // list of URLs
let thumbs = [];      // <img> elements
let current = 0;      // index
let loaded = {};      // url -> Image
let autoplayTimer = null;

// Responsive canvases
function fitCanvases(){
  const ratio = window.devicePixelRatio || 1;
  const maxW = Math.min(1400, Math.floor(window.innerWidth*0.96));
  const maxH = Math.min(900, Math.floor(window.innerHeight*0.60));
  art.style.width = maxW+'px';
  art.style.height = maxH+'px';
  art.width = Math.floor(maxW*ratio);
  art.height = Math.floor(maxH*ratio);

  fx.width = Math.floor(window.innerWidth*ratio);
  fx.height = Math.floor(window.innerHeight*ratio);
  fx.style.width = window.innerWidth+'px';
  fx.style.height = window.innerHeight+'px';
}
window.addEventListener('resize', ()=>{fitCanvases(); if(images.length) renderBinary(images[current]);});

// Manifest loader
async function fetchManifest(){
  try{
    const res = await fetch(CONFIG.MANIFEST + '?v=' + Date.now());
    if(!res.ok) throw 0;
    const list = await res.json();
    return list.map(n=> 'anh/' + n);
  }catch(e){
    // fallback numbered
    const tryUrls = [];
    for(let i=1;i<=CONFIG.FALLBACK_COUNT;i++){
      tryUrls.push(CONFIG.FALLBACK_PREFIX + i + CONFIG.FALLBACK_EXT);
    }
    // probe existence in parallel (HEAD not allowed on pages, so GET with no-cors fallback)
    const checks = await Promise.all(tryUrls.map(u=>probe(u)));
    return tryUrls.filter((_,i)=>checks[i]);
  }
}

async function probe(url){
  try{ const r = await fetch(url+'?v='+Date.now(), {method:'GET'}); return r.ok; }catch{ return false; }
}

function preload(url){
  return new Promise((resolve,reject)=>{
    if(loaded[url]) return resolve(loaded[url]);
    const img = new Image();
    img.onload = ()=>{loaded[url]=img; resolve(img)};
    img.onerror = reject;
    img.src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
  });
}

function buildStrip(urls){
  strip.innerHTML=''; thumbs=[];
  urls.forEach((u,idx)=>{
    const d=document.createElement('div'); d.className='thumb';
    const im=document.createElement('img'); im.loading='lazy'; im.src=u; d.appendChild(im);
    d.addEventListener('click',()=>{go(idx)});
    strip.appendChild(d); thumbs.push(d);
  });
}

function activate(i){
  thumbs.forEach((t,idx)=>t.classList.toggle('active', idx===i));
  // ensure visible
  const el = thumbs[i]; if(!el) return;
  const rect = el.getBoundingClientRect(); const srect = strip.getBoundingClientRect();
  if(rect.left < srect.left || rect.right > srect.right){ el.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'}); }
}

function go(i){
  current = (i+images.length)%images.length;
  renderBinary(images[current]);
  activate(current);
  if(CONFIG.AUTOPLAY) restartAutoplay();
}

function next(){ go(current+1); }
function prev(){ go(current-1); }

btnNext.addEventListener('click', next);
btnPrev.addEventListener('click', prev);
btnRender.addEventListener('click', ()=>renderBinary(images[current]));

// Binary render
async function renderBinary(url){
  if(!url){ placeholder(); return; }
  const ratio = window.devicePixelRatio || 1;
  const cell = Math.max(4, Math.floor(CONFIG.CELL * ratio));
  const pad = Math.floor(CONFIG.PADDING * ratio);
  const img = await preload(url);

  const W = art.width, H = art.height;
  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);

  // Fit image into inner box
  const availW = W - pad*2, availH = H - pad*2;
  const imgR = img.width / img.height; const boxR = availW / availH;
  let dw, dh; if(imgR>boxR){dw=availW; dh=Math.floor(availW/imgR);} else {dh=availH; dw=Math.floor(availH*imgR);} 
  const dx = Math.floor((W-dw)/2), dy = Math.floor((H-dh)/2);

  // sample pixels
  const tmp = document.createElement('canvas'); tmp.width=dw; tmp.height=dh; const tctx = tmp.getContext('2d');
  tctx.drawImage(img,0,0,dw,dh);
  const data = tctx.getImageData(0,0,dw,dh).data;

  ctx.textBaseline='middle'; ctx.textAlign='center'; ctx.font = cell+'px monospace';
  for(let y=0;y<dh;y+=cell){
    for(let x=0;x<dw;x+=cell){
      const idx = ((y*dw)+x)*4; const r=data[idx], g=data[idx+1], b=data[idx+2];
      const lum = (0.299*r + 0.587*g + 0.114*b)/255; // 0..1
      const char = pickChar(lum, CONFIG.THRESHOLD, CONFIG.MODE);
      ctx.fillStyle = lum > CONFIG.THRESHOLD ? '#6a5a80' : '#d8c6ff';
      ctx.fillText(char, dx + x + cell/2, dy + y + cell/2);
    }
  }
  // frame
  ctx.strokeStyle = 'rgba(170,130,210,0.35)';
  ctx.lineWidth = Math.max(1, ratio);
  ctx.strokeRect(dx-1,dy-1,dw+2,dh+2);
}

function pickChar(lum, th, mode){
  if(mode==='zeros') return '0';
  if(mode==='ones') return '1';
  if(mode==='random') return Math.random()>0.5?'1':'0';
  return lum>th ? '1':'0';
}

function placeholder(){
  const W=art.width,H=art.height; const ratio=window.devicePixelRatio||1; const size=Math.max(16,Math.floor(18*ratio));
  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);
  ctx.fillStyle = '#8a769f'; ctx.font = size+'px system-ui, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('ƒêang t·∫£i ·∫£nh‚Ä¶ (h√£y th√™m v√†o th∆∞ m·ª•c anh/)', W/2, H/2);
}

// Download current canvas
btnDownload.addEventListener('click', (e)=>{
  e.preventDefault();
  const url = art.toDataURL('image/png'); const a = document.createElement('a'); a.href=url; a.download='binary-love.png'; document.body.appendChild(a); a.click(); a.remove();
});

// Hearts FX ‚Äî click/hold to spawn
const hearts = [];
function spawnHearts(x,y,count=16){
  const ratio = window.devicePixelRatio||1;
  for(let i=0;i<count;i++) hearts.push({x:x*ratio,y:y*ratio,vx:(Math.random()*2-1)*2*ratio,vy:(Math.random()*-2-0.5)*ratio,life:1,rot:Math.random()*Math.PI,size:(Math.random()*10+10)*ratio});
}
function heartPath(ctx,s){ctx.moveTo(0,-s*0.35);ctx.bezierCurveTo(s*0.5,-s*1.2, s*1.6,-s*0.1, 0, s*0.9);ctx.bezierCurveTo(-s*1.6,-s*0.1, -s*0.5,-s*1.2, 0,-s*0.35);} 
function tick(){fxc.clearRect(0,0,fx.width,fx.height); const ratio=window.devicePixelRatio||1; for(let i=hearts.length-1;i>=0;i--){const h=hearts[i]; h.vy+=0.035*ratio; h.x+=h.vx; h.y+=h.vy; h.life-=0.012; if(h.life<=0){hearts.splice(i,1); continue;} fxc.save(); fxc.translate(h.x,h.y); fxc.rotate(h.rot); fxc.globalAlpha=Math.max(0,h.life); const g=fxc.createLinearGradient(-h.size,-h.size,h.size,h.size); g.addColorStop(0,'#ff8fbe'); g.addColorStop(1,'#7c5eff'); fxc.fillStyle=g; fxc.beginPath(); heartPath(fxc,h.size); fxc.closePath(); fxc.fill(); fxc.restore(); } requestAnimationFrame(tick);} 
function pointerXY(ev){ if(ev.touches&&ev.touches[0]) return {x:ev.touches[0].clientX,y:ev.touches[0].clientY}; return {x:ev.clientX,y:ev.clientY}; }
['click','pointerdown','touchstart'].forEach(evt=>window.addEventListener(evt,(e)=>{const {x,y}=pointerXY(e); spawnHearts(x,y,18);},{passive:true}));
let holdTimer=null; ['pointerdown','touchstart'].forEach(evt=>window.addEventListener(evt,(e)=>{const {x,y}=pointerXY(e); holdTimer=setInterval(()=>spawnHearts(x,y,8),120);},{passive:true})); ['pointerup','touchend','pointercancel'].forEach(evt=>window.addEventListener(evt,()=>{clearInterval(holdTimer); holdTimer=null;}));

function restartAutoplay(){ if(autoplayTimer) clearInterval(autoplayTimer); if(!CONFIG.AUTOPLAY) return; autoplayTimer=setInterval(next, CONFIG.AUTOPLAY_MS); }

// Init
fitCanvases(); placeholder();
fetchManifest().then(list=>{images=list; buildStrip(images); if(!images.length){placeholder(); return;} current=0; go(0); restartAutoplay();}).catch(()=>placeholder());
requestAnimationFrame(tick);
</script>
</body>
</html>
